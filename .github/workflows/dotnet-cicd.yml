name: .NET CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOTNET_VERSION: '8.0'
  BUILD_CONFIGURATION: 'Release'
  ARTIFACT_NAME: 'drop'

jobs:
  build-and-test:
    name: Build & Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}.x
    
    - name: Restore NuGet packages
      run: dotnet restore
    
    - name: Build solution
      run: dotnet build --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
    
    - name: Run unit tests
      run: dotnet test --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal
    
    - name: Publish artifacts
      run: dotnet publish --configuration ${{ env.BUILD_CONFIGURATION }} --output ./publish
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: ./publish

  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: ${{ env.ARTIFACT_NAME }}
    
    - name: Deploy to Dev environment
      run: |
        echo "Deploying to Dev environment..."
        echo "App Name: ${{ secrets.DEV_APP_NAME }}"
        echo "Resource Group: ${{ secrets.DEV_RESOURCE_GROUP }}"
    
    - name: Health check
      run: |
        echo "Running health checks..."
        echo "Dev deployment completed successfully"

  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: ${{ env.ARTIFACT_NAME }}
    
    - name: Deploy to QA environment
      run: |
        echo "Deploying to QA environment..."
        echo "App Name: ${{ secrets.QA_APP_NAME }}"
        echo "Resource Group: ${{ secrets.QA_RESOURCE_GROUP }}"
    
    - name: Run QA tests
      run: |
        echo "Running QA tests..."
        echo "QA deployment completed successfully"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: ${{ env.ARTIFACT_NAME }}
    
    - name: Deploy to Production environment
      run: |
        echo "Deploying to Production environment..."
        echo "App Name: ${{ secrets.PROD_APP_NAME }}"
        echo "Resource Group: ${{ secrets.PROD_RESOURCE_GROUP }}"
    
    - name: Smoke tests
      run: |
        echo "Running smoke tests..."
        echo "Production deployment completed successfully"
